name = "my-cbi-worker" # Ù†Ø§Ù… ÙˆØ±Ú©Ø± Ø´Ù…Ø§ Ú©Ù‡ Ø¯Ø± Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨ Ø§Ø³Øª
main = "src/index.js"
compatibility_date = "2024-03-20"

# ØªØ¹Ø±ÛŒÙ Ø¯ÛŒØªØ§Ø¨ÛŒØ³â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ (Ø§ÛŒÙ†Ù‡Ø§ Ø§Ø² Ù‚Ø¨Ù„ Ø¯Ø±Ø³Øª Ø¨ÙˆØ¯Ù†Ø¯)
[[kv_namespaces]]
binding = "DB"
id = "2dc096d76e484bb99717872c192b97a7"

[[kv_namespaces]]
binding = "SCORES_DB"
id = "ff32fe0bd69da49bc8f9f6bc2cc23e8e"

# ==========================================================
# <<< Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù…Ù‡Ù…â€ŒØªØ±ÛŒÙ† Ø¨Ø®Ø´ Ø§Ø³Øª Ú©Ù‡ Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ù†Ø§Ù‚Øµ Ø¨ÙˆØ¯Ù‡ >>>
# Ø§ÛŒÙ† Ú©Ø¯ Ø¨Ù‡ Ú©Ù„ÙˆØ¯ÙÙ„Ø± Ù…ÛŒâ€ŒÚ¯ÙˆÛŒØ¯ Ú©Ù‡ Ú©Ù„Ø§Ø³ BankAnnouncer Ø±Ø§ Ø¨Ø´Ù†Ø§Ø³Ø¯
# ==========================================================
[[durable_objects.bindings]]
name = "BANK_ANNOUNCER"
class_name = "BankAnnouncer"

[migrations]
dir = "./migrations"```

5.  Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø³Ø¨Ø² **"Commit changes"** Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯. Ú†Ù†Ø¯ Ø¯Ù‚ÛŒÙ‚Ù‡ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ ØªØ§ Ú©Ù„ÙˆØ¯ÙÙ„Ø± Ø§ÛŒÙ† ØªØºÛŒÛŒØ± Ø±Ø§ Ø§Ø¹Ù…Ø§Ù„ Ú©Ù†Ø¯.

---

### Ù…Ø±Ø­Ù„Ù‡ Û²: Ø§ØµÙ„Ø§Ø­ Ù†Ù‡Ø§ÛŒÛŒ Ø§ÙØ²ÙˆÙ†Ù‡ (Ø­Ù„ Ù…Ø´Ú©Ù„ Ø¯Ø§Ù†Ù„ÙˆØ¯)

Ø­Ø§Ù„Ø§ Ø¨Ø§ÛŒØ¯ Ú©Ø¯ `background.js` Ø±Ø§ Ø§ØµÙ„Ø§Ø­ Ú©Ù†ÛŒÙ… ØªØ§ Ù‚Ø§Ø¨Ù„ÛŒØª Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ú©Ø§Ø± Ú©Ù†Ø¯.

**Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„:**

1.  ÙØ§ÛŒÙ„ `background.js` Ø±Ø§ Ø¯Ø± Ù¾ÙˆØ´Ù‡ Ø§ÙØ²ÙˆÙ†Ù‡ Ø®ÙˆØ¯ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯.
2.  **ØªÙ…Ø§Ù… Ù…Ø­ØªÙˆØ§ÛŒ ÙØ¹Ù„ÛŒ** Ø±Ø§ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù‡ Ùˆ Ú©Ø¯ Ú©Ø§Ù…Ù„ Ùˆ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ø²ÛŒØ± Ø±Ø§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø¢Ù† Ú©Ù†ÛŒØ¯.

**Ú©Ø¯ Ú©Ø§Ù…Ù„ Ùˆ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ `background.js`:**

```javascript
// =====================================================================
// Ú©Ø¯ Ú©Ø§Ù…Ù„ Ùˆ Ù†Ù‡Ø§ÛŒÛŒ background.js - Ø¨Ø§ ØªÙ…Ø§Ù… Ø§ØµÙ„Ø§Ø­Ø§Øª Ù„Ø§Ø²Ù…
// =====================================================================

const WORKER_HTTP_URL = "https://my-cbi-worker.imana20.workers.dev";
const WORKER_WS_URL = "wss://my-cbi-worker.imana20.workers.dev/ws";

let socket = null;

function connectWebSocket() {
    if (socket && (socket.readyState === WebSocket.CONNECTING || socket.readyState === WebSocket.OPEN)) { return; }
    console.log('Ø¯Ø± Ø­Ø§Ù„ ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø§Ø¹Ù„Ø§Ù†Ø§Øª...');
    socket = new WebSocket(WORKER_WS_URL);
    socket.onopen = () => { console.log('âœ… Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø§Ø¹Ù„Ø§Ù†Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯.'); };
    socket.onmessage = async (event) => {
        try {
            const message = JSON.parse(event.data);
            if (message.type === 'BANK_LIST_UPDATE') {
                const { reporterId: myId } = await chrome.storage.local.get('reporterId');
                if (myId && message.reporterId && myId === message.reporterId) {
                    console.log('Ø§ÛŒÙ† Ø®Ø¨Ø± ØªÙˆØ³Ø· Ø®ÙˆØ¯ Ù…Ø§ Ú¯Ø²Ø§Ø±Ø´ Ø´Ø¯Ù‡ Ø¨ÙˆØ¯. Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.');
                    return;
                }
                console.log(`Ø®Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø§Ø² ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø¯ÛŒÚ¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯:`, message);
                const { profiles } = await chrome.storage.local.get('profiles');
                if (!profiles || profiles.length === 0) return;
                const allDesiredBanks = new Set(profiles.flatMap(p => p.banks || []));
                const matchedBank = message.banks.find(availableBank => allDesiredBanks.has(availableBank));
                if (matchedBank) {
                    console.log(`Ø¨Ø§Ù†Ú© Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ø´Ø¯: ${matchedBank}. Ø§Ø±Ø³Ø§Ù„ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø±ÙØ±Ø´...`);
                    sendRefreshSignal(matchedBank);
                }
            }
        } catch(e) { console.error("Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù… Ø§Ø² Ø³Ø±ÙˆØ±: ", e); }
    };
    socket.onclose = () => {
        console.log('ğŸ”Œ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø§Ø¹Ù„Ø§Ù†Ø§Øª Ù‚Ø·Ø¹ Ø´Ø¯.');
        socket = null;
        chrome.storage.local.get(['autoRefreshEnabled'], (result) => {
            if (result.autoRefreshEnabled) {
                console.log('ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ù…Ø¬Ø¯Ø¯ ØªØ§ 5 Ø«Ø§Ù†ÛŒÙ‡ Ø¯ÛŒÚ¯Ø±...');
                setTimeout(connectWebSocket, 5000);
            }
        });
    };
    socket.onerror = (err) => { console.error('Ø®Ø·Ø§ÛŒ WebSocket:', err); };
}

function disconnectWebSocket() { if (socket) { console.log('Ø¯Ø± Ø­Ø§Ù„ Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„ Ø§Ø² Ø³Ø±ÙˆØ± Ø§Ø¹Ù„Ø§Ù†Ø§Øª...'); socket.close(); socket = null; } }
function sendRefreshSignal(bankName) { chrome.tabs.query({ url: "https://ve.cbi.ir/VC/TasRequestVC.aspx*" }, (tabs) => { if (tabs.length > 0) { tabs.forEach(tab => { chrome.tabs.sendMessage(tab.id, { type: 'START_REFRESH', bankName: bankName }); }); } }); }

chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
    if (message.type === 'TOGGLE_REFRESH') {
        if (message.enabled) { connectWebSocket(); } else { disconnectWebSocket(); }
        sendResponse({status: "ok"});
    }
    else if (message.type === 'report_province_state') {
        console.log("Ú¯Ø²Ø§Ø±Ø´ ÙˆØ¶Ø¹ÛŒØª Ø§Ø³ØªØ§Ù† Ø§Ø² content.js Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±...");
        chrome.storage.local.get('reporterId', (result) => {
            if (!result.reporterId) { console.error("Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± (reporterId) ÛŒØ§ÙØª Ù†Ø´Ø¯. Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´ Ù…ØªÙˆÙ‚Ù Ø´Ø¯."); return; }
            const payload = { ...message, reporterId: result.reporterId };
            delete payload.type;
            fetch(`${WORKER_HTTP_URL}/report_province`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
            .then(response => response.text())
            .then(responseText => console.log("Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ± Ø¨Ù‡ Ú¯Ø²Ø§Ø±Ø´ Ø§Ø±Ø³Ø§Ù„ÛŒ:", responseText))
            .catch(error => console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´ Ø¨Ù‡ Ø³Ø±ÙˆØ±:', error));
        });
        sendResponse({status: "received"});
    }
    else if (message.type === 'download_html' && message.filename && message.htmlContent) {
        // ==========================================================
        // <<<< Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ø±Ø§ÛŒ Ø­Ù„ Ù…Ø´Ú©Ù„ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ø§Ø³Øª >>>>
        // ==========================================================
        const blob = new Blob([message.htmlContent], { type: 'text/html' });
        const reader = new FileReader();
        reader.onload = function() {
            chrome.downloads.download({
                url: reader.result, // <<<< Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Data URL Ø¨Ù‡ Ø¬Ø§ÛŒ Object URL
                filename: message.filename,
                saveAs: true
            });
        };
        reader.readAsDataURL(blob);
        sendResponse({status: "download_started"});
    }
    return true; 
});

function initialize() {
    chrome.storage.local.get('reporterId', (result) => {
        if (!result.reporterId) {
            const newId = `ext_${Date.now()}_${Math.random().toString(36).substring(2, 10)}`;
            chrome.storage.local.set({ reporterId: newId });
            console.log(`ÛŒÚ© Ø´Ù†Ø§Ø³Ù‡ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯: ${newId}`);
        }
    });
    chrome.storage.local.get(['autoRefreshEnabled'], (result) => {
        if (result.autoRefreshEnabled) {
            console.log('Ø±ÙØ±Ø´ Ø®ÙˆØ¯Ú©Ø§Ø± ÙØ¹Ø§Ù„ Ø§Ø³Øª. Ø§ØªØµØ§Ù„ Ø¯Ø± Ø²Ù…Ø§Ù† Ø§Ø³ØªØ§Ø±Øªâ€ŒØ¢Ù¾...');
            connectWebSocket();
        } else {
            console.log('Ø±ÙØ±Ø´ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø± Ø²Ù…Ø§Ù† Ø§Ø³ØªØ§Ø±Øªâ€ŒØ¢Ù¾ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª.');
        }
    });
}

chrome.runtime.onStartup.addListener(initialize);
chrome.runtime.onInstalled.addListener(initialize);
