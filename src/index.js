// =================================================================
// Ú©Ø¯ Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ ÙˆØ±Ú©Ø± - Ù†Ø³Ø®Ù‡ 4.0 (Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø§ÛŒ Syntax)
// =================================================================


// Ø¨Ø®Ø´ Û±: ØªØ¹Ø±ÛŒÙ Ú©Ù„Ø§Ø³ Ù¾Ø§ÛŒØ¯Ø§Ø± (Durable Object)
// =================================================================

export class BankAnnouncer {
    constructor(state, env) {
        this.state = state;
        this.sessions = [];
    }

    async handleWebSocket(request) {
        const [client, server] = Object.values(new WebSocketPair());
        server.accept();
        this.sessions.push(server);

        const closeOrErrorHandler = () => {
            this.sessions = this.sessions.filter(s => s !== server);
        };
        server.addEventListener("close", closeOrErrorHandler);
        server.addEventListener("error", closeOrErrorHandler);

        return new Response(null, { status: 101, webSocket: client });
    }

    async handleAnnounce(request) {
        try {
            const { bankName } = await request.json();
            if (!bankName) return new Response("Error: 'bankName' is required.", { status: 400 });

            this.sessions = this.sessions.filter(session => {
                try {
                    session.send(JSON.stringify({ type: 'BANK_ANNOUNCEMENT', bankName: bankName }));
                    return true;
                } catch (e) {
                    return false;
                }
            });
            
            return new Response(`Successfully announced '${bankName}'.`, { status: 200 });
        } catch (e) {
            return new Response(`Error: ${e.message}`, { status: 500 });
        }
    }

    async fetch(request) {
        const upgradeHeader = request.headers.get("Upgrade");
        if (upgradeHeader === "websocket") {
            return this.handleWebSocket(request);
        }
        if (request.method === "POST") {
            return this.handleAnnounce(request);
        }
        return new Response("This endpoint is for WebSocket or POST requests.", { status: 400 });
    }
}


// Ø¨Ø®Ø´ Û²: Ø±ÙˆØªØ± Ø§ØµÙ„ÛŒ ÙˆØ±Ú©Ø±
// Ø§ÛŒÙ† Ø¨Ø®Ø´ ØªÙ…Ø§Ù… Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø±Ø¯Ù‡ Ùˆ Ø¨Ù‡ Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ·Ù‡ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
// =================================================================

export default {
    async fetch(request, env) {
        const url = new URL(request.url);

        // Û±. Ø§Ú¯Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø±Ø§ÛŒ WebSocket ÛŒØ§ Ø§Ø¹Ù„Ø§Ù† Ø¨Ø§Ø´Ø¯ØŒ Ø¢Ù† Ø±Ø§ Ø¨Ù‡ BankAnnouncer Ø¨ÙØ±Ø³Øª
        if (url.pathname.startsWith('/ws') || url.pathname.startsWith('/announce')) {
            if (!env.BANK_ANNOUNCER) {
                return new Response("Durable Object 'BANK_ANNOUNCER' is not configured.", { status: 500 });
            }
            const id = env.BANK_ANNOUNCER.idFromName("global-announcer");
            const stub = env.BANK_ANNOUNCER.get(id);
            return stub.fetch(request);
        }

        // Û². Ø§Ú¯Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù… Ø¨Ø§Ø´Ø¯ØŒ Ø¢Ù† Ø±Ø§ Ø¨Ù‡ ØªÙˆØ§Ø¨Ø¹ Ù…Ø±Ø¨ÙˆØ·Ù‡ Ø¨ÙØ±Ø³Øª
        if (url.pathname === "/report_province") {
            return handleProvinceUpdate(request, env);
        } else if (url.pathname.startsWith("/webhook")) {
            return handleTelegramWebhook(request, env);
        }

        // Û³. Ø¯Ø± ØµÙˆØ±ØªÛŒ Ú©Ù‡ Ù‡ÛŒÚ† Ù…Ø³ÛŒØ±ÛŒ Ù…Ø·Ø§Ø¨Ù‚Øª Ù†Ø¯Ø§Ø´Øª
        return new Response("Not Found", { status: 404 });
    }
};


// Ø¨Ø®Ø´ Û³: ØªÙ…Ø§Ù… Ú©Ø¯Ù‡Ø§ Ùˆ ØªÙˆØ§Ø¨Ø¹ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù… Ø´Ù…Ø§
// =================================================================

const BANK_MAP = { "12": "Ø¨Ø§Ù†Ú© Ù…Ù„Øª", "13": "Ø¨Ø§Ù†Ú© Ø±ÙØ§Ù‡ Ú©Ø§Ø±Ú¯Ø±Ø§Ù†", "15": "Ø¨Ø§Ù†Ú© Ø³Ù¾Ù‡", "16": "Ø¨Ø§Ù†Ú© Ú©Ø´Ø§ÙˆØ±Ø²ÛŒ", "17": "Ø¨Ø§Ù†Ú© Ù…Ù„ÛŒ Ø§ÛŒØ±Ø§Ù†", "18": "Ø¨Ø§Ù†Ú© ØªØ¬Ø§Ø±Øª", "19": "Ø¨Ø§Ù†Ú© ØµØ§Ø¯Ø±Ø§Øª", "20": "Ø¨Ø§Ù†Ú© ØªÙˆØ³Ø¹Ù‡ ØµØ§Ø¯Ø±Ø§Øª Ø§ÛŒØ±Ø§Ù†", "21": "Ù¾Ø³Øª Ø¨Ø§Ù†Ú© Ø§ÛŒØ±Ø§Ù†", "22": "Ø¨Ø§Ù†Ú© ØªÙˆØ³Ø¹Ù‡ ØªØ¹Ø§ÙˆÙ†", "53": "Ø¨Ø§Ù†Ú© Ú©Ø§Ø±Ø¢ÙØ±ÛŒÙ†", "54": "Ø¨Ø§Ù†Ú© Ù¾Ø§Ø±Ø³ÛŒØ§Ù†", "55": "Ø¨Ø§Ù†Ú© Ø§Ù‚ØªØµØ§Ø¯ Ù†ÙˆÛŒÙ†", "56": "Ø¨Ø§Ù†Ú© Ø³Ø§Ù…Ø§Ù†", "57": "Ø¨Ø§Ù†Ú© Ù¾Ø§Ø³Ø§Ø±Ú¯Ø§Ø¯", "59": "Ø¨Ø§Ù†Ú© Ø³ÛŒÙ†Ø§", "60": "Ø¨Ø§Ù†Ú© Ù‚Ø±Ø¶ Ø§Ù„Ø­Ø³Ù†Ù‡ Ù…Ù‡Ø± Ø§ÛŒØ±Ø§Ù†", "61": "Ø¨Ø§Ù†Ú© Ø´Ù‡Ø±", "62": "Ø¨Ø§Ù†Ú© Ø¢ÛŒÙ†Ø¯Ù‡", "64": "Ø¨Ø§Ù†Ú© Ú¯Ø±Ø¯Ø´Ú¯Ø±ÛŒ", "70": "Ø¨Ø§Ù†Ú© Ù‚Ø±Ø¶ Ø§Ù„Ø­Ø³Ù†Ù‡ Ø±Ø³Ø§Ù„Øª", "75": "Ù…ÙˆØ³Ø³Ù‡ Ø§Ø¹ØªØ¨Ø§Ø±ÛŒ Ù…Ù„Ù„" };
const PROVINCE_LIST = ["Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§Ù† Ø´Ø±Ù‚ÛŒ", "Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§Ù† ØºØ±Ø¨ÛŒ", "Ø§Ø±Ø¯Ø¨ÛŒÙ„", "Ø§ØµÙÙ‡Ø§Ù†", "Ø§Ù„Ø¨Ø±Ø²", "Ø§ÛŒÙ„Ø§Ù…", "Ø¨ÙˆØ´Ù‡Ø±", "ØªÙ‡Ø±Ø§Ù†", "Ú†Ù‡Ø§Ø±Ù…Ø­Ø§Ù„ Ùˆ Ø¨Ø®ØªÛŒØ§Ø±ÛŒ", "Ø®Ø±Ø§Ø³Ø§Ù† Ø¬Ù†ÙˆØ¨ÛŒ", "Ø®Ø±Ø§Ø³Ø§Ù† Ø±Ø¶ÙˆÛŒ", "Ø®Ø±Ø§Ø³Ø§Ù† Ø´Ù…Ø§Ù„ÛŒ", "Ø®ÙˆØ²Ø³ØªØ§Ù†", "Ø²Ù†Ø¬Ø§Ù†", "Ø³Ù…Ù†Ø§Ù†", "Ø³ÛŒØ³ØªØ§Ù† Ùˆ Ø¨Ù„ÙˆÚ†Ø³ØªØ§Ù†", "ÙØ§Ø±Ø³", "Ù‚Ø²ÙˆÛŒÙ†", "Ù‚Ù…", "Ú©Ø±Ø¯Ø³ØªØ§Ù†", "Ú©Ø±Ù…Ø§Ù†", "Ú©Ø±Ù…Ø§Ù†Ø´Ø§Ù‡", "Ú©Ù‡Ú¯ÛŒÙ„ÙˆÛŒÙ‡ Ùˆ Ø¨ÙˆÛŒØ±Ø§Ø­Ù…Ø¯", "Ú¯Ù„Ø³ØªØ§Ù†", "Ú¯ÛŒÙ„Ø§Ù†", "Ù„Ø±Ø³ØªØ§Ù†", "Ù…Ø§Ø²Ù†Ø¯Ø±Ø§Ù†", "Ù…Ø±Ú©Ø²ÛŒ", "Ù‡Ø±Ù…Ø²Ú¯Ø§Ù†", "Ù‡Ù…Ø¯Ø§Ù†", "ÛŒØ²Ø¯"];

// ... (ØªÙ…Ø§Ù… ØªÙˆØ§Ø¨Ø¹ Ø¯ÛŒÚ¯Ø± Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù… Ø´Ù…Ø§ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯)
function getTehranDateTime() { const tehranOffset = 3.5 * 60 * 60 * 1000; const tehranDate = new Date(Date.now() + tehranOffset); const shamsiDate = new Intl.DateTimeFormat('fa-IR-u-nu-latn', { year: 'numeric', month: '2-digit', day: '2-digit' }).format(tehranDate); const time = tehranDate.getUTCHours().toString().padStart(2, '0') + ':' + tehranDate.getUTCMinutes().toString().padStart(2, '0') + ':' + tehranDate.getUTCSeconds().toString().padStart(2, '0'); return { shamsiDate, time }; }
function timeToMinutes(timeStr) { if (!timeStr || !timeStr.includes(':')) return -1; const parts = timeStr.split(':'); const hours = parseInt(parts[0], 10); const minutes = parseInt(parts[1], 10); if (isNaN(hours) || isNaN(minutes)) return -1; return hours * 60 + minutes; }
const ADMIN_MAIN_MENU = { inline_keyboard: [[{ text: "ğŸ‘¤ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§ÙØ²ÙˆÙ†Ù‡", callback_data: "menu_reporters" }], [{ text: "ğŸ“£ Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø´ØªØ±Ú©ÛŒÙ† (Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§)", callback_data: "menu_subscribers" }], [{ text: "ğŸ“ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø³ØªØ§Ù† ÙØ¹Ø§Ù„", callback_data: "menu_province_focus" }]] };
const REPORTERS_MENU = { inline_keyboard: [[{ text: "ğŸ“œ Ù„ÛŒØ³Øª Ú©Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†", callback_data: "list_reporters" }], [{ text: "âœï¸ ØªØºÛŒÛŒØ± Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±", callback_data: "start_rename" }], [{ text: "ğŸš« Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø±", callback_data: "start_ban" }], [{ text: "âœ… Ø±ÙØ¹ Ù…Ø³Ø¯ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø±", callback_data: "start_unban" }], [{ text: "ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ", callback_data: "main_menu" }]] };
const SUBSCRIBERS_MENU = { inline_keyboard: [[{ text: "ğŸ“œ Ù„ÛŒØ³Øª Ú©Ø§Ù…Ù„ Ù…Ø´ØªØ±Ú©ÛŒÙ†", callback_data: "list_subscribers" }], [{ text: "â• Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø´ØªØ±Ú© Ø¬Ø¯ÛŒØ¯", callback_data: "start_add_subscriber" }], [{ text: "ğŸ”„ ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù…Ø´ØªØ±Ú©", callback_data: "start_toggle_subscriber" }], [{ text: "ğŸ—‘ Ø­Ø°Ù Ù…Ø´ØªØ±Ú©", callback_data: "start_remove_subscriber" }], [{ text: "ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ", callback_data: "main_menu" }]] };
const PROVINCE_FOCUS_MENU = { inline_keyboard: [[{ text: "ğŸ¯ Ø§Ù†ØªØ®Ø§Ø¨/ØªØºÛŒÛŒØ± Ø§Ø³ØªØ§Ù† ÙØ¹Ø§Ù„", callback_data: "start_set_focus" }], [{ text: "ğŸŒ Ù„ØºÙˆ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª (Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ù‡Ù…Ù‡ Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§)", callback_data: "clear_focus" }], [{ text: "ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ", callback_data: "main_menu" }]] };
async function handleProvinceUpdate(request, env) { const DB = env.DB; const SUBSCRIBERS_KEY = "subscribers_data"; const REPORTERS_DATA_KEY = "reporters_data"; const FOCUSED_PROVINCE_KEY = "focused_province"; if (request.method !== 'POST') return new Response('POST requests only', { status: 405 }); try { const { province, ids: currentIdsString, time: samaneTime, reporterId } = await request.json(); if (!province || typeof currentIdsString === 'undefined' || !reporterId) { return new Response('Invalid data. "province", "ids", and "reporterId" are required.', { status: 400 }); } const { time: workerTime } = getTehranDateTime(); if (samaneTime) { const samaneMinutes = timeToMinutes(samaneTime); const workerMinutes = timeToMinutes(workerTime); if (samaneMinutes !== -1 && workerMinutes !== -1 && Math.abs(workerMinutes - samaneMinutes) > 2) { return new Response(`Stale data rejected. Page time: ${samaneTime}, Server time: ${workerTime}`, { status: 409 }); } } const reportersDataString = await DB.get(REPORTERS_DATA_KEY); const reportersData = reportersDataString ? JSON.parse(reportersDataString) : {}; const reporterInfo = reportersData[reporterId]; if (reporterInfo && reporterInfo.status === 'banned') { return new Response('Your access is restricted.', { status: 403 }); } const provinceStorageKey = `list_${province}`; const previousIdsString = await DB.get(provinceStorageKey); if (previousIdsString !== currentIdsString) { await DB.put(provinceStorageKey, currentIdsString); const currentScore = (reporterInfo && reporterInfo.score) ? reporterInfo.score : 0; reportersData[reporterId] = { ...reporterInfo, score: currentScore + 1, status: 'active' }; await DB.put(REPORTERS_DATA_KEY, JSON.stringify(reportersData)); const subscribersDataString = await DB.get(SUBSCRIBERS_KEY); const subscribersData = subscribersDataString ? JSON.parse(subscribersDataString) : {}; const activeSubscribers = Object.keys(subscribersData).filter(id => subscribersData[id].status === 'active'); const focusedProvince = await DB.get(FOCUSED_PROVINCE_KEY); if (activeSubscribers.length > 0 && (!focusedProvince || province === focusedProvince)) { const { shamsiDate, time: preciseTime } = getTehranDateTime(); let finalUpdateTime = (samaneTime && preciseTime.startsWith(samaneTime)) ? preciseTime : `${samaneTime || 'Ù†Ø§Ù…Ø´Ø®Øµ'} (Ø«Ø¨Øª Ø¯Ø±: ${preciseTime})`; const bankIds = currentIdsString.split(',').filter(id => id); const bankNames = bankIds.map(id => BANK_MAP[id] || `Ø¨Ø§Ù†Ú© Ù†Ø§Ø´Ù†Ø§Ø³ (${id})`); let formattedText = `ğŸ“¢ <b>ØªØºÛŒÛŒØ±Ø§Øª Ø¬Ø¯ÛŒØ¯ Ø¯Ø± Ù„ÛŒØ³Øª Ø¨Ø§Ù†Ú©â€ŒÙ‡Ø§ÛŒ Ø§Ø³ØªØ§Ù† Â«${province}Â»</b>\n\n`; if (bankNames.length > 0) { bankNames.forEach(name => { formattedText += `ğŸ”¹ ${name}\n`; }); } else { formattedText += `âŒ <i>Ø¯Ø± Ø§ÛŒÙ† Ø§Ø³ØªØ§Ù†ØŒ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ù‡ÛŒÚ† Ø¨Ø§Ù†Ú©ÛŒ ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª.</i>\n`; } formattedText += `\nğŸ—“ ØªØ§Ø±ÛŒØ®: <code>${shamsiDate}</code>\nğŸ•°ï¸ Ø²Ù…Ø§Ù† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: <code>${finalUpdateTime}</code>`; const updatedReporterInfo = reportersData[reporterId]; if (updatedReporterInfo && updatedReporterInfo.name) { formattedText += `\n\nğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙˆØ³Ø·: <b>${updatedReporterInfo.name}</b>`; } formattedText += `\n\nğŸ†” @vam_farzand<a href="https://t.me/vam_farzand?start=trigger"> </a>`; for (const chatId of activeSubscribers) { await sendOrEditMessage(chatId, formattedText, null, env); } return new Response("Change processed, notifications sent, and score updated.", { status: 200 }); } else if (activeSubscribers.length > 0 && focusedProvince && province !== focusedProvince) { return new Response(`Update for [${province}] processed, but notification suppressed due to focus on [${focusedProvince}].`, { status: 202 }); } return new Response("Change processed and score updated (no active subscribers or notifications).", { status: 200 }); } return new Response("No change detected for this province.", { status: 200 }); } catch (e) { return new Response("Error: " + e.message, { status: 500 }); } }
async function handleTelegramWebhook(request, env) { const DB = env.DB; const update = await request.json(); const ADMIN_USER_ID = 477003598; if (update.callback_query) { const chatId = update.callback_query.message.chat.id; if (chatId !== ADMIN_USER_ID) return new Response("OK"); await handleCallbackQuery(update.callback_query, env); } else if (update.message) { const chatId = update.message.chat.id; const text = update.message.text ? update.message.text.trim() : ""; if (chatId !== ADMIN_USER_ID) { return new Response("OK"); } const stateKey = `state_${chatId}`; const userStateJSON = await DB.get(stateKey); const userState = userStateJSON ? JSON.parse(userStateJSON) : null; if (userState) { await handleStatefulMessage(update.message, userState, env); } else if (text === "/admin") { await sendOrEditMessage(chatId, "ğŸ›  Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", ADMIN_MAIN_MENU, env); } } return new Response("OK"); }
async function handleCallbackQuery(callbackQuery, env) { const { data: callbackData, message } = callbackQuery; const chatId = message.chat.id; const stateKey = `state_${chatId}`; const DB = env.DB; const SUBSCRIBERS_KEY = "subscribers_data"; const FOCUSED_PROVINCE_KEY = "focused_province"; const REPORTERS_DATA_KEY = "reporters_data"; if (callbackData === "main_menu") { await DB.delete(stateKey); await sendOrEditMessage(chatId, "ğŸ›  Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯:", ADMIN_MAIN_MENU, env, message.message_id); } else if (callbackData === "menu_reporters") { await sendOrEditMessage(chatId, "ğŸ‘¤ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§ÙØ²ÙˆÙ†Ù‡:", REPORTERS_MENU, env, message.message_id); } else if (callbackData === "list_reporters") { await executeListReporters(chatId, env, message.message_id); } else if (callbackData === "start_rename") { await showReportersAsButtons(chatId, env, message.message_id, "rename_reporter", "âœï¸ Ù†Ø§Ù… Ú©Ø¯Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯ØŸ"); } else if (callbackData.startsWith("rename_reporter:")) { const reporterId = callbackData.substring("rename_reporter:".length); await DB.put(stateKey, JSON.stringify({ action: "awaiting_new_name", reporterId: reporterId })); await sendOrEditMessage(chatId, `âœï¸ Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± <code>${reporterId.substring(0, 8)}...</code> Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.\n\nØ¨Ø±Ø§ÛŒ Ù„ØºÙˆ /cancel Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.`, null, env, message.message_id); } else if (callbackData === "start_ban") { await showReportersAsButtons(chatId, env, message.message_id, "ban_reporter", "ğŸš« Ú©Ø¯Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù…Ø³Ø¯ÙˆØ¯ Ú©Ù†ÛŒØ¯ØŸ"); } else if (callbackData.startsWith("ban_reporter:")) { const reporterId = callbackData.substring("ban_reporter:".length); const reportersDataString = await DB.get(REPORTERS_DATA_KEY); let reportersData = reportersDataString ? JSON.parse(reportersDataString) : {}; reportersData[reporterId] = { ...reportersData[reporterId], status: 'banned' }; await DB.put(REPORTERS_DATA_KEY, JSON.stringify(reportersData)); await sendOrEditMessage(chatId, `ğŸš« Ú©Ø§Ø±Ø¨Ø± <code>${reporterId.substring(0, 8)}...</code> Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯.`, REPORTERS_MENU, env, message.message_id); } else if (callbackData === "start_unban") { await showReportersAsButtons(chatId, env, message.message_id, "unban_reporter", "âœ… Ú©Ø¯Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø±ÙØ¹ Ù…Ø³Ø¯ÙˆØ¯ÛŒ Ú©Ù†ÛŒØ¯ØŸ"); } else if (callbackData.startsWith("unban_reporter:")) { const reporterId = callbackData.substring("unban_reporter:".length); const reportersDataString = await DB.get(REPORTERS_DATA_KEY); let reportersData = reportersDataString ? JSON.parse(reportersDataString) : {}; reportersData[reporterId] = { ...reportersData[reporterId], status: 'active' }; await DB.put(REPORTERS_DATA_KEY, JSON.stringify(reportersData)); await sendOrEditMessage(chatId, `âœ… Ú©Ø§Ø±Ø¨Ø± <code>${reporterId.substring(0, 8)}...</code> Ø±ÙØ¹ Ù…Ø³Ø¯ÙˆØ¯ÛŒ Ø´Ø¯.`, REPORTERS_MENU, env, message.message_id); } else if (callbackData === "menu_subscribers") { await sendOrEditMessage(chatId, "ğŸ“£ Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø´ØªØ±Ú©ÛŒÙ† (Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ Ùˆ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§):", SUBSCRIBERS_MENU, env, message.message_id); } else if (callbackData === "list_subscribers") { await executeListSubscribers(chatId, env, message.message_id); } else if (callbackData === "start_add_subscriber") { await DB.put(stateKey, JSON.stringify({ action: "awaiting_subscriber_add" })); await sendOrEditMessage(chatId, "â• Ù„Ø·ÙØ§Ù‹ Ø´Ù†Ø§Ø³Ù‡ Ø¹Ø¯Ø¯ÛŒ (Chat ID) Ú©Ø§Ù†Ø§Ù„ ÛŒØ§ Ú¯Ø±ÙˆÙ‡ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.\n\nØ¨Ø±Ø§ÛŒ Ù„ØºÙˆ /cancel Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.", null, env, message.message_id); } else if (callbackData === "start_remove_subscriber") { await showSubscribersAsButtons(chatId, env, message.message_id, "remove_subscriber", "ğŸ—‘ Ú©Ø¯Ø§Ù… Ù…Ø´ØªØ±Ú© Ø±Ø§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ"); } else if (callbackData.startsWith("remove_subscriber:")) { const subscriberIdToRemove = callbackData.substring("remove_subscriber:".length); const subscribersDataString = await DB.get(SUBSCRIBERS_KEY); let subscribersData = subscribersDataString ? JSON.parse(subscribersDataString) : {}; delete subscribersData[subscriberIdToRemove]; await DB.put(SUBSCRIBERS_KEY, JSON.stringify(subscribersData)); await sendOrEditMessage(chatId, `ğŸ—‘ Ù…Ø´ØªØ±Ú© Ø¨Ø§ Ø´Ù†Ø§Ø³Ù‡ <code>${subscriberIdToRemove}</code> Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.`, SUBSCRIBERS_MENU, env, message.message_id); } else if (callbackData === "start_toggle_subscriber") { await showSubscribersAsButtons(chatId, env, message.message_id, "toggle_subscriber", "ğŸ”„ ÙˆØ¶Ø¹ÛŒØª Ú©Ø¯Ø§Ù… Ù…Ø´ØªØ±Ú© Ø±Ø§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯ØŸ"); } else if (callbackData.startsWith("toggle_subscriber:")) { const subscriberIdToToggle = callbackData.substring("toggle_subscriber:".length); const subscribersDataString = await DB.get(SUBSCRIBERS_KEY); let subscribersData = subscribersDataString ? JSON.parse(subscribersDataString) : {}; if (subscribersData[subscriberIdToToggle]) { const currentStatus = subscribersData[subscriberIdToToggle].status; const newStatus = currentStatus === 'active' ? 'inactive' : 'active'; subscribersData[subscriberIdToToggle].status = newStatus; await DB.put(SUBSCRIBERS_KEY, JSON.stringify(subscribersData)); const statusText = newStatus === 'active' ? 'âœ… ÙØ¹Ø§Ù„' : 'â¸ ØºÛŒØ±ÙØ¹Ø§Ù„ (ØªØ³ØªÛŒ)'; await sendOrEditMessage(chatId, `ğŸ”„ ÙˆØ¶Ø¹ÛŒØª Ù…Ø´ØªØ±Ú© <code>${subscriberIdToToggle}</code> Ø¨Ù‡ <b>${statusText}</b> ØªØºÛŒÛŒØ± ÛŒØ§ÙØª.`, SUBSCRIBERS_MENU, env, message.message_id); } } else if (callbackData === "menu_province_focus") { const focusedProvince = await DB.get(FOCUSED_PROVINCE_KEY); let messageText = "ğŸ“ Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø±Ø§ Ø¨Ù‡ ÛŒÚ© Ø§Ø³ØªØ§Ù† Ø®Ø§Øµ Ù…Ø­Ø¯ÙˆØ¯ Ú©Ù†ÛŒØ¯."; if (focusedProvince) { messageText += `\n\nğŸŸ¢ <b>Ø§Ø³ØªØ§Ù† ÙØ¹Ø§Ù„ ÙØ¹Ù„ÛŒ: Â«${focusedProvince}Â»</b>`; } else { messageText += `\n\nğŸŒ <b>Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ù‡Ù…Ù‡ Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</b>`; } await sendOrEditMessage(chatId, messageText, PROVINCE_FOCUS_MENU, env, message.message_id); } else if (callbackData === "start_set_focus") { await showProvincesAsButtons(chatId, env, message.message_id, "set_focus", "ğŸ¯ Ù„Ø·ÙØ§Ù‹ Ø§Ø³ØªØ§Ù†ÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒâ€ŒÙ‡Ø§ Ø¨Ù‡ Ø¢Ù† Ù…Ø­Ø¯ÙˆØ¯ Ø´ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:"); } else if (callbackData.startsWith("set_focus:")) { const provinceToFocus = callbackData.substring("set_focus:".length); await DB.put(FOCUSED_PROVINCE_KEY, provinceToFocus); await sendOrEditMessage(chatId, `âœ… Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯.\nØ§Ø² Ø§ÛŒÙ† Ù¾Ø³ ÙÙ‚Ø· Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§Ø³ØªØ§Ù† Â«<b>${provinceToFocus}</b>Â» Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.`, ADMIN_MAIN_MENU, env, message.message_id); } else if (callbackData === "clear_focus") { await DB.delete(FOCUSED_PROVINCE_KEY); await sendOrEditMessage(chatId, `âœ… Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø§Ø³ØªØ§Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø±Ø¯Ø§Ø´ØªÙ‡ Ø´Ø¯.\nØ§Ø² Ø§ÛŒÙ† Ù¾Ø³ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒâ€ŒÙ‡Ø§ÛŒ <b>ØªÙ…Ø§Ù… Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§</b> Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.`, ADMIN_MAIN_MENU, env, message.message_id); } }
async function handleStatefulMessage(message, state, env) { const DB = env.DB; const chatId = message.chat.id; const text = message.text.trim(); const stateKey = `state_${chatId}`; if (text === "/cancel") { await DB.delete(stateKey); await sendOrEditMessage(chatId, "Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.", ADMIN_MAIN_MENU, env); return; } if (state.action === "awaiting_new_name") { const reporterId = state.reporterId; const newName = text; const reportersDataString = await DB.get("reporters_data"); let reportersData = reportersDataString ? JSON.parse(reportersDataString) : {}; reportersData[reporterId] = { ...reportersData[reporterId], name: newName }; await DB.put("reporters_data", JSON.stringify(reportersData)); await DB.delete(stateKey); await sendOrEditMessage(chatId, `âœ… Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ "<b>${newName}</b>" ØªØºÛŒÛŒØ± ÛŒØ§ÙØª.`, REPORTERS_MENU, env); } else if (state.action === "awaiting_subscriber_add") { const newSubscriberId = text; if (!/^-?\d+$/.test(newSubscriberId)) { await sendOrEditMessage(chatId, "âŒ Ø®Ø·Ø§: ÙˆØ±ÙˆØ¯ÛŒ Ø¨Ø§ÛŒØ¯ ÛŒÚ© Ø´Ù†Ø§Ø³Ù‡ Ø¹Ø¯Ø¯ÛŒ Ù…Ø¹ØªØ¨Ø± Ø¨Ø§Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯ ÛŒØ§ /cancel Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.", null, env); return; } const SUBSCRIBERS_KEY = "subscribers_data"; const subscribersDataString = await DB.get(SUBSCRIBERS_KEY); let subscribersData = subscribersDataString ? JSON.parse(subscribersDataString) : {}; if (subscribersData[newSubscriberId]) { await sendOrEditMessage(chatId, `âš ï¸ Ø§ÛŒÙ† Ù…Ø´ØªØ±Ú© (<code>${newSubscriberId}</code>) Ø§Ø² Ù‚Ø¨Ù„ Ø¯Ø± Ù„ÛŒØ³Øª ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯.`, SUBSCRIBERS_MENU, env); } else { subscribersData[newSubscriberId] = { status: "active" }; await DB.put(SUBSCRIBERS_KEY, JSON.stringify(subscribersData)); await sendOrEditMessage(chatId, `âœ… Ù…Ø´ØªØ±Ú© Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ø´Ù†Ø§Ø³Ù‡ <code>${newSubscriberId}</code> Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ùˆ ÙØ¹Ø§Ù„ Ø´Ø¯.`, SUBSCRIBERS_MENU, env); } await DB.delete(stateKey); } }
async function showSubscribersAsButtons(chatId, env, messageId, actionPrefix, messageText) { const subscribersDataString = await env.DB.get("subscribers_data"); const subscribersData = subscribersDataString ? JSON.parse(subscribersDataString) : {}; const subscriberIds = Object.keys(subscribersData); if (subscriberIds.length === 0) { await sendOrEditMessage(chatId, "Ù‡ÛŒÚ† Ù…Ø´ØªØ±Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.", SUBSCRIBERS_MENU, env, messageId); return; } const keyboardButtons = subscriberIds.map(id => { const info = subscribersData[id]; const statusEmoji = info.status === 'active' ? 'âœ…' : 'â¸'; const buttonText = `${statusEmoji} Ú©Ø§Ù†Ø§Ù„/Ú¯Ø±ÙˆÙ‡: ${id}`; return [{ text: buttonText, callback_data: `${actionPrefix}:${id}` }]; }); keyboardButtons.push([{ text: "ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data: "menu_subscribers" }]); await sendOrEditMessage(chatId, messageText, { inline_keyboard: keyboardButtons }, env, messageId); }
async function executeListSubscribers(chatId, env, messageId = null) { const subscribersDataString = await env.DB.get("subscribers_data"); const subscribersData = subscribersDataString ? JSON.parse(subscribersDataString) : {}; const subscriberIds = Object.keys(subscribersData); let listText = "<b>ğŸ“£ Ù„ÛŒØ³Øª Ú©Ø§Ù…Ù„ Ù…Ø´ØªØ±Ú©ÛŒÙ† (Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§/Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§):</b>\n\n"; if (subscriberIds.length > 0) { subscriberIds.forEach(id => { const info = subscribersData[id]; const statusText = info.status === 'active' ? 'âœ… ÙØ¹Ø§Ù„' : 'â¸ ØºÛŒØ±ÙØ¹Ø§Ù„ (ØªØ³ØªÛŒ)'; listText += `- Ø´Ù†Ø§Ø³Ù‡: <code>${id}</code> | ÙˆØ¶Ø¹ÛŒØª: <b>${statusText}</b>\n`; }); } else { listText += "<i>Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ù…Ø´ØªØ±Ú©ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</i>"; } await sendOrEditMessage(chatId, listText, SUBSCRIBERS_MENU, env, messageId); }
async function showReportersAsButtons(chatId, env, messageId, actionPrefix, messageText) { const reportersDataString = await env.DB.get("reporters_data"); const reportersData = reportersDataString ? JSON.parse(reportersDataString) : {}; const reporterIds = Object.keys(reportersData); if (reporterIds.length === 0) { await sendOrEditMessage(chatId, "Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.", REPORTERS_MENU, env, messageId); return; } const keyboardButtons = reporterIds.map(id => { const info = reportersData[id]; const buttonText = info.name ? info.name : `Ú©Ø§Ø±Ø¨Ø± (${id.substring(0, 8)}...)`; return [{ text: buttonText, callback_data: `${actionPrefix}:${id}` }]; }); keyboardButtons.push([{ text: "ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data: "menu_reporters" }]); await sendOrEditMessage(chatId, messageText, { inline_keyboard: keyboardButtons }, env, messageId); }
async function executeListReporters(chatId, env, messageId = null) { const reportersDataString = await env.DB.get("reporters_data"); const reportersData = reportersDataString ? JSON.parse(reportersDataString) : {}; let listText = "<b>ğŸ“Š Ù„ÛŒØ³Øª Ú©Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§ÙØ²ÙˆÙ†Ù‡:</b>\n\n"; const reporterIds = Object.keys(reportersData); if (reporterIds.length > 0) { reporterIds.forEach(id => { const info = reportersData[id]; const statusEmoji = info.status === 'banned' ? 'ğŸš« Ù…Ø³Ø¯ÙˆØ¯' : 'âœ… ÙØ¹Ø§Ù„'; listText += `ğŸ‘¤ <b>${info.name || '<i>(Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…)</i>'}</b>\n`; listText += `ğŸ†” <code>${id}</code>\n`; listText += `â­ Ø§Ù…ØªÛŒØ§Ø²: <b>${info.score || 0}</b> | ${statusEmoji}\nâ€” â€” â€” â€” â€” â€”\n`; }); } else { listText += "<i>Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</i>"; } await sendOrEditMessage(chatId, listText, REPORTERS_MENU, env, messageId); }
async function showProvincesAsButtons(chatId, env, messageId, actionPrefix, messageText) { const keyboardRows = []; let currentRow = []; for (const province of PROVINCE_LIST) { currentRow.push({ text: province, callback_data: `${actionPrefix}:${province}` }); if (currentRow.length === 2) { keyboardRows.push(currentRow); currentRow = []; } } if (currentRow.length > 0) { keyboardRows.push(currentRow); } keyboardRows.push([{ text: "ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§Ø³ØªØ§Ù†", callback_data: "menu_province_focus" }]); await sendOrEditMessage(chatId, messageText, { inline_keyboard: keyboardButtons }, env, messageId); }
async function sendOrEditMessage(chatId, text, keyboard, env, messageId = null) { const BOT_TOKEN = '8123012760:AAFPWhUq9gOUFitH7kk-VM4hQ6xFTk9P4k8'; const url = messageId ? `https://api.telegram.org/bot${BOT_TOKEN}/editMessageText` : `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`; const payload = { chat_id: chatId, text: text, parse_mode: 'HTML' }; if (messageId) { payload.message_id = messageId; } if (keyboard) { payload.reply_markup = keyboard; } else if (messageId) { payload.reply_markup = { inline_keyboard: [] }; } try { await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); } catch (e) { console.error("Send/Edit Message Error:", e); } }
